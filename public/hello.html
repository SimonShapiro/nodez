<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Page Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/javascripts/jquery-copy/jquery.mobile-1.4.2.css" />
    <link rel="stylesheet" href="/javascripts/jquery-copy/jquery-ui.css" />
    <script src="/javascripts/jquery-copy/jquery-1.10.2.js"></script>
    <script src="/javascripts/jquery-copy/jquery-ui.js"></script>
    <script src="/javascripts/jquery-copy/jquery.mobile-1.4.2.js"></script>
    <script>
        // Module /spa/
        // Provides chat slider capability
        //
        var spa = (function ($) {

            var
            // Declare all other module scope variables
                    metaNodes,          onClickSlider,          initModule,
                    processMetaNodes,   displayTemplate,        getNodeData,
                    getNodes,           targetNodes,            loadNodeNamesIntoList,
                    targetSchema,       frameworkAttributeList, saveCurrentNode,
                    currentNode,        currentNodeId;

            frameworkAttributeList = [ "creationDate","revision", "uuid", "lastModifiedDate" ];

            saveCurrentNode = function() {
                var i,  browser_data,
                    browser_data_object = {};

                alert( "Saving: "+currentNodeId )
                browser_data = $( '.nodeBrowserData' );
                for (i in browser_data ) {
                    browser_data_object[browser_data[i].id] = browser_data[i].value
                }
                //add framework fields object
                for ( i in frameworkAttributeList ) {
                    browser_data_object[frameworkAttributeList[i]]=currentNode[frameworkAttributeList[i]]
                }
                alert( JSON.stringify(browser_data_object ))
            }

            loadNodeNamesIntoList = function () {
                var $new_item

                if ($( '#nodeNames' ).length ) {
                    $( '#nodeNames' ).remove();
                    $( '#nodeDetails').children().remove();
                    $( '#detailsHeader').text( 'Details' );
                }
                $( '<ul/>', {id:'nodeNames', "data-role":'listview', "data-filter":"true"} ).appendTo( $( '#nodesList' ) );
                $( '#nodeNames').filterable();
                $( '#nodeNames').listview();
                for (i in targetNodes) {
                    $new_item = $ ( '<li class="line" ><a id="'+i+'" href="#">'+targetNodes[i].data.name+'</a></li>');
                    /*
                     $( '<li/>', {text: data[i].data.name,
                     class:"line",
                     id: i
                     }).click( getNodeData ).appendTo( $( '#lines') );
                     //        .mouseover( displayTemplate ).click( getNodeData )
                     //        .appendTo( $( '#lines' ) );
                     */
                    $new_item.click( showNodeData ).appendTo( $( '#nodeNames' ));
                }
                $( '#nodeNames').listview('refresh')
            }

            getNodes = function ( event ) {
                var target_node_label = metaNodes[event.target.id].data.name;

                targetSchema = {};
                if ( metaNodes[event.target.id].data.hasOwnProperty( "schema" )) {
                    targetSchema = JSON.parse(metaNodes[event.target.id].data.schema)
                }
                $( '#nodesHeader').text( target_node_label );
                // request nodes by type
                ajax_request = $.ajax({
                    url: '/neo4j/nodes/label/' + target_node_label,
                    type: 'get',
                    headers: {Accept: 'application/json'},
                    success: function (data) {
                        targetNodes = data
                        loadNodeNamesIntoList()
                    },
                    error: function (data) {
                        alert('error ', data['responseText'])
                    }
                });
            }

            presentNodeData = function ( node_data ) {
                var $input_field,       html_stub,      field_size,
                    n, t, d,
                    display_order = [];

                currentNode = node_data.data;

                $( '#nodeDetails').children().remove();
                $( '#detailsHeader').text( 'Details' );
                for (t in targetSchema) {
                    display_order.push( t );
                }
                for ( n in node_data.data ) {
                    // now display balance of non-framework attributes
                    if ( ( display_order.indexOf( n ) == -1 ) && ( frameworkAttributeList.indexOf( n ) == -1 )) {
                        display_order.push( n );
                    }
                }
                for ( d in display_order ) {
                    n = display_order[d];
                    if ( node_data.data[n].hasOwnProperty( "length" )) {
                        field_size = Math.min( node_data.data[n].length,60 );
                    }
                    else {
                        field_size = 2;
                    }
                    html_stub = '<div class="ui-field-contain">'
                                +   '<label for="'+n+'">'+n+':</label>\n';

                    // style the widget based on the format entry in the schema
                    if ( targetSchema[n] ) {
                        if ( targetSchema[n].hasOwnProperty("format") ) {
                            // switch to one of the html5 text input types
                            switch ( targetSchema[n].format ) {
                                case "textarea": {
                                    html_stub = html_stub + '<textarea class="nodeBrowserData" id="'+n+'" style="width: 95%">\n</textarea>\n';
                                    break;
                                }
                                case "number": {
                                    html_stub = html_stub + '<input type="number" class="nodeBrowserData" id="'+n+'" size="'+field_size+'">\n';
                                    break;
                                }
                                case "date": {
                                    html_stub = html_stub + '<input type="date" class="nodeBrowserData" id="'+n+'" size="'+field_size+'">\n';
                                    break;
                                }
                                default: {
                                    html_stub = html_stub + '<input type="text" class="nodeBrowserData" id="'+n+'" size="'+field_size+'">\n';
                                    break;
                                }
                            }
                        }
                        else {
                            html_stub = html_stub + '<input type="text" class="nodeBrowserData" id="'+n+'" size="'+field_size+'">\n'
                        }
                    }
                    else {
                        html_stub = html_stub + '<input type="text" class="nodeBrowserData" id="'+n+'" size="'+field_size+'">\n'
                    }
                    html_stub = html_stub + '</div>';
                    $( '#nodeDetails' ).append( $( html_stub)).css( "padding-left", "20px");
                    $( '#'+n ).val( node_data.data[n] );
                }
                $( '#detailsHeader').text( node_data.data['name'] );

                // show relationships
                $( "#nodeDetails").append( '<hr>' );
                for ( n in node_data.outLinkDetails ) {
                    $( '#nodeDetails').append( '<p>'+n+'</p>' );
                    for ( k in node_data.outLinkDetails[n] ) {
                        $( '#nodeDetails').append( '<li>'+ node_data.outLinkDetails[n][k].endName+'</li>')
                    }
                }
                for ( n in node_data.inLinkDetails ) {
                    $( '#nodeDetails').append( '<p>Inverse of '+n+'</p>' );
                    for ( k in node_data.inLinkDetails[n] ) {
                        $( '#nodeDetails').append( '<li>'+ node_data.inLinkDetails[n][k].endName+'</li>' )
                    }
                }
                return true;
            };

            showNodeData = function ( event ) {
                var target_node_data = targetNodes[event.target.id].data,
                    target_node_id = targetNodes[event.target.id].id[0],
                    node_data;
                currentNodeId = target_node_id;
                ajax_request = $.ajax({
                    url: '/neo4j/node/' + target_node_id + '/navigate',
                    type: 'get',
                    headers: {Accept: 'application/json'},
                    success: function (data) {
                        node_data = data;
                        presentNodeData( node_data );
//                        $( '#nodeDetails').append( '<p id="navigateJSON">' + JSON.stringify(verbose_node_html) + '</p>');
                    },
                    error: function (data) {
                        alert('error ', data['responseText'])
                    }
                });
            }
            // Process Meta nodes /processMetaNodes/
            // receives Meta data and places into their containers and attaches them
            // to the DOM
            processMetaNodes = function (data ) {
                var $new_item;
                $( '<ul/>', {id:'lines', "data-role":'listview', "data-filter":"true"} ).appendTo( $( '#Meta' ) );
                $( '#lines').listview();
                for (i in data) {
                    $new_item = $ ( '<li class="line" ><a id="'+i+'" href="#">'+data[i].data.name+'</a></li>');
                    /*
                    $( '<li/>', {text: data[i].data.name,
                        class:"line",
                        id: i
                    }).click( getNodeData ).appendTo( $( '#lines') );
                    //        .mouseover( displayTemplate ).click( getNodeData )
                    //        .appendTo( $( '#lines' ) );
                     */
                    $new_item.click( getNodes ).appendTo( $( '#lines' ));
                }
                $( '#lines').listview('refresh')
            }
            // Public method /initModule/
            // sets initial state and provides feature
            //
            initModule = function ($container) {
                $container.find( "#inspect" ).click( function() {alert( "Hello" )} )
                $container.find( '#save').click( saveCurrentNode )

                // request nodes by type
                ajax_request = $.ajax({
                    url: '/neo4j/nodes/label/Meta',
                    type: 'get',
                    headers: {Accept: 'application/json'},
                    success: function (data) {
                        metaNodes = data
                        processMetaNodes(data)},
                    error: function (data) {
                        alert('error ', data['responseText'])
                    }
                });
                return true;
            };

            return { initModule: initModule }

        }(jQuery));
        // Start spa once DOM is ready
        //
        jQuery(document).ready(
        function () {
            spa.initModule(jQuery('#spa'));
        }
        );
    </script>
</head>

<body>
    <div data-role="page" id="spa">
        <div class="ui-grid-c">
            <div class="ui-block-a" style="width: 20%" id="Meta"><div class="ui-bar ui-bar-a" style="height:15px">Meta</div>
            </div>
            <div class="ui-block-b" style="width: 20%" id="nodesList"><div id="nodesHeader" class="ui-bar ui-bar-a" style="height:15px"></div>
            </div>
            <div class="ui-block-c" style="width: 60%"><div id="detailsHeader" class="ui-bar ui-bar-a" style="height:15px">Details</div>
                <div id="nodeDetails">
                </div><!-- /grid-a -->
            </div>
        </div>
        <div id="controls"><button id="save">Save</button></div>
    </div>
</body>
</html>

